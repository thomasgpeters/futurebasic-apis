include "Tlbx AVKit.incl"#plist NSMicrophoneUsageDescription @"Your microphone will be used to record sounds." // required#plist NSCameraUsageDescription     @"Your camera will be used to display video."     // required_window = 1begin enum 1_captureViewend enumvoid local fn BuildWindowCGRect r = (0,0,814,508)window _window, @"AVCaptureView", ravcaptureview _captureView, rViewSetAutoresizingMask( _captureView, NSViewWidthSizable + NSViewHeightSizable )AVCaptureViewSetVideoGravity( _captureView, AVLayerVideoGravityResizeAspectFill )end fnvoid local fn StartRecording( fileOutput as AVCaptureFileOutputRef )CFURLRef urlurl = fn FileManagerURLForDirectory( NSDesktopDirectory, NSUserDomainMask )url = fn URLByAppendingPathComponent( url, @"MyVideoFile.m4a" )AVCaptureFileOutputStartRecordingToURL( fileOutput, url )end fnvoid local fn DoAppEvent( ev as long )select ( ev )case _appDidFinishLaunching : fn BuildWindowcase _appShouldTerminateAfterLastWindowClosed : AppEventSetBool( YES )end selectend fnvoid local fn DoDialog( ev as long, tag as long, wnd as long, obj as CFTypeRef )select ( ev )case _avCaptureViewStartRecordingToFileOutput : fn StartRecording( obj )// obj is AVCaptureFileOutputRefend selectend fnon dialog fn DoDialogon appevent fn DoAppEventHandleEvents