/*  SpriteKit GIF Animation Demo  Demonstrates how to parse out frames in a GIF image and load them  as an array of SKTextures to be played as an animation with SpriteKit.  Dependency:  Demo uses the GIF file available here, but could easily be adapted to other GIFs.  https://miro.medium.com/max/1600/1*Zns4of7kzkNclLOxSGtwRg.gif  Download the GIF file, rename it "cartoon.gif", and include it in your bundle.  Ken Shmidheiser  20 March 2020  macOS 10.12+*/output file "SpriteKit GIF Animation"include "Tlbx SpriteKit.incl"include resources "cartoon.gif"_openPanel = 1_window = 1begin enum output 1_skView_playBtn_quitBtnend enumvoid local fn BuildWindowlong   wndStyleMaskCGRect rwndStyleMask  = NSWindowStyleMaskTitledwndStyleMask += NSWindowStyleMaskClosablewndStyleMask += NSWindowStyleMaskMiniaturizabler = fn CGRectMake( 0, 0, 600, 500 )window _window, @"SpriteKit GIF Animation", r, wndStyleMaskWindowSetBackgroundColor( _window, fn ColorBlack )r = fn CGRectMake( 0, 50, 600, 450 )skview _skView, r, _window// SKViewSetShowsDrawCount( _skView, YES )// SKViewSetShowsFPS( _skView, YES )// SKViewSetShowsNodeCount( _skView, YES )r = fn CGRectMake( 498, 15, 90, 24 )button _quitBtn,,, @"Quit", r, NSButtonTypeMomentaryLight, NSBezelStyleSmallSquare, _windowButtonSetBordered( _quitBtn, NO )ButtonSetBackgroundColor( _quitBtn, fn ColorDarkGray )ButtonSetTitleColor( _quitBtn, fn ColorWhite )end fnlocal fn ConvertGIFToImageSequence as CFMutableArrayRefCFURLRef           urlCFDataRef          imageDataCFDictionaryRef    gifOptionsCGImageSourceRef   imageSourceNSUInteger         i, framesCountCGImageRef         cgImageRefImageRef           tempImageCFMutableArrayRef  imageMutArrayCGSize             sizeurl = fn BundleURLForImageResource( fn BundleMain, @"cartoon" )size = fn CGSizeMake( 800, 600 )imageData = fn DataWithContentsOfURL( url, NSDataReadingMappedIfSafe, NULL )gifOptions = @{ kCGImageSourceShouldAllowFloat:@(YES), kCGImageSourceCreateThumbnailWithTransform:@(YES), kCGImageSourceCreateThumbnailFromImageAlways:@(YES) }imageSource = fn CGImageSourceCreateWithData( imageData, gifOptions )imageMutArray = fn MutableArrayWithCapacity( 0 )framesCount = fn CGImageSourceGetCount( imageSource )for i = 0 to framesCount - 1cgImageRef = fn CGImageSourceCreateImageAtIndex( imageSource, i, NULL )tempImage = fn ImageWithCGImage( cgImageRef, size )MutableArrayAddObject( imageMutArray, tempImage )nextCFRelease( imageSource )CGImageRelease( cgImageRef )end fn = imageMutArraylocal fn CreateScene as SKSceneRefSKSceneRef   scenefloat        sceneWidth, sceneHeightsceneWidth  = 600.0sceneHeight = 450.0scene = fn SKSceneWithSize( fn CGSizeMake( sceneWidth, sceneHeight ) )SKSceneSetBackgroundColor( scene, fn ColorBlack )SKSceneSetScaleMode( scene, SKSceneScaleModeAspectFit )SKViewPresentScene( _skView, scene )end fn = scenevoid local fn BuildSKViewCFMutableArrayRef  imageArray, cartoonframesfloat              sceneWidth, sceneHeightSKTextureRef       textureSKSpriteNodeRef    nodeImageRef           imagesceneWidth  = 600.0sceneHeight = 450.0cartoonframes = fn MutableArrayWithCapacity(0)imageArray = fn ConvertGIFToImageSequencefor image in imageArraytexture = fn SKTextureWithImage( image )MutableArrayAddObject( cartoonFrames, texture )nextnode = fn SKSpriteNodeWithTextureSize( fn ArrayFirstObject( cartoonframes ), fn CGSizeMake( sceneWidth, sceneHeight ) )SKNodeSetPosition( node, fn CGPointMake( sceneWidth/2, sceneHeight/2 ) )SKNodeRunAction( node, fn SKActionRepeatActionForever( fn SKActionAnimateWithTextures( cartoonframes, 0.1 ) ) )SKNodeAddChild( fn CreateScene, node )end fnvoid local fn DoDialog( ev as long, tag as long )select (ev)case _btnClickselect (tag)case _quitBtn : endend selectcase _windowShouldClose : endend selectend fnon dialog fn DoDialogfn BuildWindowfn CreateScenefn BuildSKViewHandleEvents