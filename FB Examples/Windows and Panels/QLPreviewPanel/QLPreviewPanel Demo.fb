/*   QLPreviewPanel Demo*/include "NSLog.incl"_mFile = 1begin enum_iChooseDirectoryend enum_mEdit = 2_window = 1begin enum 1_tableViewend enum_openPanel = 1void local fn CreateTableData( dirURL as CFURLRef )CFURLRef          fileURLImageRef          imageCFDictionaryRef   dictWindowSetTitleWithRepresentedURL( _window, dirURL )CFArrayRef files = fn FileManagerContentsOfDirectoryAtURL( dirURL, @[NSURLNameKey], NSDirectoryEnumerationSkipsHiddenFiles )CFMutableArrayRef tableData = fn TableViewData(_tableView)MutableArrayRemoveAllObjects( tableData )for fileURL in filesimage = fn WorkspaceIconForFileAtURL( fileURL )dict = @{@"Image":image,@"Name":fn URLLastPathComponent(fileURL)}MutableArrayAddObject( tableData, dict )nextTableViewReloadData(_tableView)end fnvoid local fn ChooseDirectoryOpenPanelSetCanChooseDirectories( _openPanel, YES )OpenPanelSetCanChooseFiles( _openPanel, NO )CFURLRef url = openpanel _openPanel, @"Choose Directory",, @"Choose"if ( url )fn CreateTableData( url )end ifend fnvoid local fn BuildMenumenu _mFile,,, @"File"menu _mFile, _iChooseDirectory,, @"Choose Directoryâ€¦", @"o"editmenu _mEditend fnvoid local fn BuildWindownibwindow _window, @"Window"CFURLRef dirURL = fn FileManagerURLForDirectory( NSDesktopDirectory, NSUserDomainMask )fn CreateTableData( dirURL )WindowMakeFirstResponder( _window, _tableView )end fnvoid local fn DoMenu( menuID as long, itemID as long )select ( menuID )case _mFileselect ( itemID )case _iChooseDirectory : fn ChooseDirectoryend selectend selectend fnvoid local fn DoDialog( ev as long, tag as long )CFStringRef     chars, filenameNSUInteger      countCFArrayRef      tableData, filesIndexSetRef     indexesCFDictionaryRef dictCFURLRef        dirURL, urlselect ( ev )case _viewKeyDownchars = fn EventCharactersif ( fn StringIsEqual( chars, @" " ) )QLPreviewPanelToggleDialogEventSetBool( YES )// we handledend ifcase _qlPreviewPanelNumberOfItemscount = fn IndexSetCount( fn TableViewSelectedRowIndexes(_tableView) )DialogEventSetLong( count )case _qlPreviewPanelItemAtIndextableData = fn TableViewData(_tableView)indexes = fn TableViewSelectedRowIndexes( _tableView )files = fn ArrayObjectsAtIndexes( tableData, indexes )dict = fn ArrayObjectAtIndex( files, tag )filename = fn DictionaryObjectForKey( dict, @"Name" )dirURL = fn WindowRepresentedURL( _window )url = fn URLByAppendingPathComponent( dirURL, filename )DialogEventSetURL(url)QLPreviewPanelReloadDatacase _windowWillCloseendend selectend fnfn BuildMenufn BuildWindowon menu fn DoMenuon dialog fn DoDialogHandleEvents