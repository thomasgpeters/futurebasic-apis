/*  Simple Background Thread 2  Bernie Wylde 20180306*/include "NSLog.incl"_doSomethingPanel = 1_progBar = 1_mainWindow = 2_startBtn = 1void local fn ViewDrawdouble          max, valueBezierPathRef   pathColorRef        strokeCol, fillColvalue = fn ProgressIndicatorDoubleValue( _progBar )strokeCol = fn ColorWithRGB(0.82,0.82,0.82,1.0)fillCol = fn ColorWithRGB(0.86,0.86,0.86,1.0)BezierPathStrokeFillRoundedRect( fn CGRectMake(21.5,30.5,357,6.0), 2.5, 2.5, 1.0, strokeCol, fillCol )if ( value )max = fn ProgressIndicatorMaxValue( _progBar )value = value/max * 352 + 24path = fn BezierPathInitBezierPathMoveToPoint( path, fn CGPointMake(23.5,33.5) )BezierPathLineToPoint( path, fn CGPointMake(value,33.5) )BezierPathSetLineWidth( path, 5.5 )BezierPathSetLineCapStyle( path, NSLineCapStyleRound )ColorSet( fn ColorRed )BezierPathStroke( path )end ifend fnvoid local fn Finished// main threadbutton _startBtn, YES,,,,,, _mainWindowend fnvoid local fn UpdateSomeStuff// main threadif ( fn WindowExists(_doSomethingPanel) )// Make sure the window still existswindow output _doSomethingPanel// Send widget calls go to the correct windowProgressIndicatorIncrementBy( _progBar, 1.0 )ViewSetNeedsDisplay( _windowContentViewTag )end ifend fnvoid local fn BackgroundFunction// background threadlong ifor i = 0 to 100delay 10ObjectCallFunctionOnMainThread( @fn UpdateSomeStuff, NULL, YES )// update UI elements and do drawing on main threadnext iObjectCallFunctionOnMainThread( @fn Finished, NULL, YES )// we're doneend fnvoid local fn Start// main threadbutton _startBtn, NOwindow _doSomethingPanelprogressbar _progBar, 0,,,, _doSomethingPanelProgressIndicatorSetUsesThreadedAnimation( _progBar, NO )// fix cosmetic on Big Sur and aboveObjectCallFunctionInBackground( @fn BackgroundFunction, NULL )end fnvoid local fn BuildWindowswindow _mainWindow, @"Main Window", (0,0,550,400)button _startBtn,,, @"Start"panel _doSomethingPanel, @"Doing something in background", (0,0,400,98)WindowSubclassContentView(_doSomethingPanel)progressbar _progBar,, (20,59,360,20)ProgressIndicatorSetUsesThreadedAnimation( _progBar, NO )// fix cosmetic on Big Sur and aboveend fnvoid local fn DoAppEvent( ev as long )select ( ev )case _appWillFinishLaunchingfn BuildWindowsend selectend fnvoid local fn DoDialog( ev as long, tag as long )select ( ev )case _btnClickselect ( tag )case _startBtn : fn Startend selectcase _viewDrawRect : fn ViewDrawend selectend fnon AppEvent fn DoAppEventon dialog fn DoDialogHandleEvents