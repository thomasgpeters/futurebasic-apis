/*  QR Code Reader  A utility app that decodes data from QR Code images  and converts data into human readable form.  Ken Shmidheiser  June 26, 2018  macOS 10.10+*/include "Tlbx CoreImage.incl"output file "QR Code Reader"_mApplication = 0begin enum_iAbout_iSeparator_iPreferencesend enum_mFile = 1begin enum_iOpenend enum_mEdit = 2_window = 1begin enum output 1_imageView_infoLabel_textField_openBtn_stringAlertend enumvoid local fn BuildMenuMenuItemSetOnMenuAction( _mApplication, _iAbout )menu _mApplication, _iSeparatormenu _mApplication, _iPreferences,, @"Preferences…", @","menu _mFile, -1,, @"File"menu _mFile, _iOpen,, @"Select QR Code…", @"o"editmenu _mEditend fnvoid local fn BuildWindowlong   wndStyleMaskwndStyleMask  = NSWindowStyleMaskTitledwndStyleMask += NSWindowStyleMaskClosablewndStyleMask += NSWindowStyleMaskMiniaturizableCGRect r = ( 0, 0, 300, 450 )window _window, @"QR Code Reader", r, wndStyleMaskr = fn CGRectMake( 40, 215, 210, 210 )imageview _imageView, YES,, r, NSImageScaleProportionallyUpOrDown, NSImageAlignCenter, NSImageFramePhoto, _windowImageViewSetEditable( _imageView, YES )ImageViewSetAllowsCutCopyPaste( _imageView, YES )r = fn CGRectMake( 18, 177, 250, 22 )textlabel _infoLabel, @"QR Code data:", r, _windowr = fn CGRectMake( 20, 55, 260, 120 )textfield _textField, YES,, r, _windowTextFieldSetEditable( _textField, YES )TextFieldSetSelectable( _textField, YES )TextFieldSetBordered( _textField, YES )r = fn CGRectMake( 100, 15, 185, 28 )button _openBtn, YES, , @"Select QR Code image…", r, NSButtonTypeMomentaryLight, NSBezelStyleRegularSquare, _windowend fnCFStringRef local fn QRCodeToString( ciImage as CIImageRef )CFStringRef   string = NULLCFDictionaryRef detectorOptions = @{CIDetectorAccuracy:CIDetectorAccuracyHigh}CIDetectorRef detector = fn CIDetectorOfType( CIDetectorTypeQRCode, NULL, detectorOptions )CFArrayRef features = fn CIDetectorFeaturesInImage( detector, ciImage )if ( features )string = fn CIQRCodeFeatureMessageString( fn ArrayObjectAtIndex( features, 0 ) )end ifend fn = stringvoid local fn ReadQRCodeFromImage( image as ImageRef )CFDataRef dta = fn ImageTIFFRepresentation( image )CIImageRef ciImage = fn CIImageWithData( dta )CFStringRef qrCodeString = fn QRCodeToString( ciImage )if ( qrCodeString )ControlSetStringValue( _textField, qrCodeString )elsealert _stringAlert, NSAlertStyleWarning, @"Failed to find QR Code data.", @"Image does not appear to be a valid QR Code, or is corrupted.", @"Okay", YESend ifend fnvoid local fn OpenImageFileImageRef   imageCFURLRef url = openpanel 1, @"Select a QR Code image to its decrypt its data.", @"public.image", @"Select QR Code image…"if ( url )image = fn ImageByReferencingURL( url )ImageViewSetImage( _imageView, image )fn ReadQRCodeFromImage( image )end ifend fnvoid local fn DoDialog( ev as long, tag as long )select (ev)case _btnClickselect (tag)case _openBtn   : fn OpenImageFilecase _imageView : fn ReadQRCodeFromImage( fn ImageViewImage( tag ) )end selectcase _windowWillClose : endend selectend fnvoid local fn DoMenu( menuID as long, itemID as long )CFMutableAttributedStringRef   attrStrCFDictionaryRef                dictselect (menuID)case _mApplicationselect (itemID)case _iAboutattrStr = fn MutableAttributedStringWithString( @"A utility to decode QR Code (Quick Response Code) image data into human readable form." )dict = @{@"Credits":attrStr,@"ApplicationName":@"QR Code Reader",@"Version":@"1.0",@"Copyright":@"Copyright 2018 Ken Shmidheiser",@"ApplicationVersion":@"1.0 alpha"}AppOrderFrontStandardAboutPanelWithOptions( dict )end selectcase _mFileselect (itemID )case _iOpen  : fn OpenImageFileend selectend selectend fnon menu fn DoMenuon dialog fn DoDialogfn BuildMenufn BuildWindowHandleEvents