/*CIUnsharpMask and CISharpenLuminanceThis demo shows how to combine two different image sharpening filters.Ken Shmidheiser6 February 2020*/include "Tlbx CoreImage.incl"output file "Image Sharpener"include resources "waterfall.jpg"_window = 1begin enum output 1_originalImageView_sharpenedImageView_radiusSlider_intensitySlider_sharpnessSlider_radiusValueField_intensityValueField_sharpnessValueField_originalImageLabel_sharpenedImageLabel_radiusLabel_intensitylLabel_sharpnessLabelend enumvoid local fn BuildWindowNSInteger   wndStyleMaskwndStyleMask  = NSWindowStyleMaskTitledwndStyleMask += NSWindowStyleMaskClosablewndStyleMask += NSWindowStyleMaskMiniaturizableCGRect r = ( 0, 0, 1130, 600 )window _window, @"Image Sharpener", r, wndStyleMaskr = fn CGRectMake( 20, 20, 440, 540 )imageview _originalImageView, YES, @"waterfall.jpg", r, NSImageScaleAxesIndependently, NSImageAlignCenter, NSImageFramePhoto, _windowr = fn CGRectMake( 470, 20, 440, 540 )imageview _sharpenedImageView, YES,, r, NSImageScaleAxesIndependently, NSImageAlignCenter, NSImageFramePhoto, _windowr = fn CGRectMake( 935, 40, 40, 520 )slider _radiusSlider, YES, 2.50, r, 0.0, 100.0, NO, _windowControlSetContinuous( _radiusSlider, YES )r = fn CGRectMake( 995, 40, 40, 520 )slider _intensitySlider, YES, 0.50, r, 0.0, 4.0, NO, _windowControlSetContinuous( _intensitySlider, YES )r = fn CGRectMake( 1060, 40, 40, 520 )slider _sharpnessSlider, YES, 0.40, r, 0.0, 5.0, NO, _windowControlSetContinuous( _sharpnessSlider, YES )r = fn CGRectMake( 935, 20, 40, 17 )textlabel _radiusValueField, @"2.50", r, _windowControlSetAlignment( _radiusValueField, NSTextAlignmentCenter )r = fn CGRectMake( 990, 20, 40, 16 )textlabel _intensityValueField, @"0.50", r, _windowControlSetAlignment( _intensityValueField, NSTextAlignmentCenter )r = fn CGRectMake( 1060, 20, 40, 16 )textlabel _sharpnessValueField, @"0.40", r, _windowControlSetAlignment( _sharpnessValueField, NSTextAlignmentCenter )r = fn CGRectMake( 20, 570, 440, 17 )textlabel _originalImageLabel, @"Original Image", r, _windowControlSetAlignment( _originalImageLabel, NSTextAlignmentCenter )r = fn CGRectMake( 470, 570, 440, 17 )textlabel _sharpenedImageLabel, @"Sharpened Image", r, _windowControlSetAlignment( _sharpenedImageLabel, NSTextAlignmentCenter )r = fn CGRectMake( 925, 570, 60, 17 )textlabel _radiusLabel, @"Radius", r, _windowControlSetAlignment( _radiusLabel, NSTextAlignmentCenter )r = fn CGRectMake( 980, 570, 64, 17 )textlabel _intensitylLabel, @"Intensity", r, _windowControlSetAlignment( _intensitylLabel, NSTextAlignmentCenter )r = fn CGRectMake( 1040, 570, 80, 17 )textlabel _sharpnessLabel, @"Sharpness", r, _windowControlSetAlignment( _sharpnessLabel, NSTextAlignmentCenter )end fnlocal fn ImageRefToCIImage( image as ImageRef ) as CIImageRefCFDataRef dta = fn ImageTIFFRepresentationUsingCompression( image, NSTIFFCompressionNone, 0.0 )end fn = fn CIImageWithData( dta )local fn CIImageToImageRef( ciImage as CIImageRef ) as ImageRefCIImageRepRef rep = fn CIImageRepWithCIImage( ciImage )CGSize size = fn ImageRepSize( rep )ImageRef image = fn ImageWithSize( size )ImageAddRepresentation( image, rep )end fn = imagelocal fn SharpenImageWithFilter( inputCIImage as CIImageRef, radius as CFNumberRef, intensity as CFNumberRef, sharpness as CFNumberRef ) as CIImageRefCIFilterRef   unsharpMaskFilter, sharpenFilterunsharpMaskFilter = fn CIFilterWithNameAndInputParameters( @"CIUnsharpMask", @{ @"inputImage":inputCIImage, @"inputRadius":radius, @"inputIntensity":intensity } )CIImageRef unsharpCIImage = fn CIFilterOutputImage( unsharpMaskFilter )sharpenFilter =  fn CIFilterWithNameAndInputParameters( @"CISharpenLuminance", @{ @"inputImage":unsharpCIImage, @"inputSharpness":sharpness } )end fn = fn CIFilterOutputImage( sharpenFilter )void local fn SharpenImagedouble       intensitySliderValue, radiusSliderValue, sharpenSliderValueCFNumberRef  radius, intensity, sharpnessImageRef     originalImage, sharpenedImageCIImageRef   ciImage, ciSharpenedImageradiusSliderValue = fn ControlDoubleValue( _radiusSlider )intensitySliderValue = fn ControlDoubleValue( _intensitySlider )sharpenSliderValue = fn ControlDoubleValue( _sharpnessSlider )radius = @( radiusSliderValue )intensity = @( intensitySliderValue )sharpness = @( sharpenSliderValue )originalImage = fn ImageViewImage( _originalImageView )ciImage = fn ImageRefToCIImage( originalImage )ciSharpenedImage = fn SharpenImageWithFilter( ciImage, radius, intensity, sharpness )sharpenedImage = fn CIImageToImageRef( ciSharpenedImage )ImageViewSetImage( _sharpenedImageView, sharpenedImage )end fnvoid local fn DoDialog( ev as long, tag as long, wnd as long, obj as CFTypeRef )double   radius, intensity, sharpnessselect (ev)case _btnClickselect (tag )case _radiusSliderradius = fn ControlDoubleValue( tag )ControlSetDoubleValue( _radiusValueField, radius )fn SharpenImagecase _intensitySliderintensity = fn ControlDoubleValue( tag )ControlSetDoubleValue( _intensityValueField, intensity )fn SharpenImagecase _sharpnessSlidersharpness = fn ControlDoubleValue( tag )ControlSetDoubleValue( _sharpnessValueField, sharpness )fn SharpenImageend selectcase _windowWillClose : endend selectend fnon dialog fn DoDialogfn BuildWindowfn SharpenImageHandleEvents