/*CISepiaToneSimple demo of applying the CISepiaTone filter to an image.Ken Shmidheiser8 February 2020*/include "Tlbx CoreImage.incl"output file "Sepial Image Toner"include resources "waterfall.jpg"_window = 1begin enum output 1_originalImageView_sepiaImageView_intensitySlider_intensityValueField_originalImageLabel_sepiaImageLabel_intensitylLabelend enumvoid local fn BuildWindowlong   wndStyleMaskwndStyleMask  = NSWindowStyleMaskTitledwndStyleMask += NSWindowStyleMaskClosablewndStyleMask += NSWindowStyleMaskMiniaturizableCGRect r = ( 0, 0, 1030, 600 )window _window, @"Sepial Image Toner", r, wndStyleMaskr = fn CGRectMake( 20, 20, 440, 540 )imageview _originalImageView, YES, @"waterfall.jpg", r, NSImageScaleAxesIndependently, NSImageAlignCenter, NSImageFramePhoto, _windowr = fn CGRectMake( 470, 20, 440, 540 )imageview _sepiaImageView, YES,, r, NSImageScaleAxesIndependently, NSImageAlignCenter, NSImageFramePhoto, _windowr = fn CGRectMake( 935, 40, 40, 510 )slider _intensitySlider, YES, 0.0, r, 0.0, 1.0, NO, _windowControlSetContinuous( _intensitySlider, YES )r = fn CGRectMake( 935, 20, 40, 17 )textlabel _intensityValueField, @"0.0", r, _windowControlSetAlignment( _intensityValueField, NSTextAlignmentCenter )r = fn CGRectMake( 20, 570, 440, 17 )textlabel _originalImageLabel, @"Original Image", r, _windowControlSetAlignment( _originalImageLabel, NSTextAlignmentCenter )r = fn CGRectMake( 470, 570, 440, 17 )textlabel _sepiaImageLabel, @"Sepia Toned Image", r, _windowControlSetAlignment( _sepiaImageLabel, NSTextAlignmentCenter )r = fn CGRectMake( 470, 570, 440, 17 )textlabel _sepiaImageLabel, @"Sepia Toned Image", r, _windowControlSetAlignment( _sepiaImageLabel, NSTextAlignmentCenter )r = fn CGRectMake( 925, 550, 60, 42 )textlabel _intensitylLabel, @"Sepia Intensity", r, _windowControlSetAlignment( _intensitylLabel, NSTextAlignmentCenter )end fnlocal fn ImageRefToCIImage( image as ImageRef ) as CIImageRefCFDataRef dta = fn ImageTIFFRepresentationUsingCompression( image, NSTIFFCompressionNone, 0.0 )end fn = fn CIImageWithData( dta )local fn CIImageToImageRef( ciImage as CIImageRef ) as ImageRefCIImageRepRef rep = fn CIImageRepWithCIImage( ciImage )CGSize size = fn ImageRepSize( rep )ImageRef image = fn ImageWithSize( size )ImageAddRepresentation( image, rep )end fn = imagelocal fn SepiaTone( inputCIImage as CIImageRef, intensity as CFNumberRef ) as CIImageRefCIFilterRef sepiaToneFilter = fn CIFilterWithNameAndInputParameters( @"CISepiaTone", @{ @"inputImage":inputCIImage, @"inputIntensity":intensity } )end fn = fn CIFilterOutputImage( sepiaToneFilter )void local fn ToneImageImageRef     originalImage, tonedImageCIImageRef   ciImage, ciTonedImagedouble intensitySliderValue = fn ControlDoubleValue( _intensitySlider )CFNumberRef intensity = @(intensitySliderValue)originalImage = fn ImageViewImage( _originalImageView )ciImage = fn ImageRefToCIImage( originalImage )ciTonedImage = fn SepiaTone( ciImage, intensity )tonedImage = fn CIImageToImageRef( ciTonedImage )ImageViewSetImage( _sepiaImageView, tonedImage )end fnvoid local fn DoDialog( ev as long, tag as long, wnd as long, obj as CFTypeRef )double   intensityselect (ev)case _btnClickselect (tag )case _intensitySliderintensity = fn ControlDoubleValue( tag )ControlSetDoubleValue( _intensityValueField, intensity )fn ToneImageend selectcase _windowWillClose : endend selectend fnon dialog fn DoDialogfn BuildWindowfn ToneImageHandleEvents