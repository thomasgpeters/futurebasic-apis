/*  Marching Ants Selection Demo v02.4  20210325 Ken Shmidheiser*/output file "Marching Ants Selection"include "NSLog.incl"_window = 1begin enum 1_label_antViewend enumlocal fn BuildWindowwindow _window, @"Marching Ants Selection", ( 0, 0, 500, 300 )textlabel _label, @"Click mouse down and drag to see marching ants selection.", ( 40, 250, 420, 32 ), _windowControlSetAlignment( _label, NSTextAlignmentCenter )subclass view _antView, ( 0, 0, 500, 300 ), _windowViewSetAutoresizingMask( _antView, NSViewWidthSizable + NSViewHeightSizable )end fnlocal fn DoDialog( ev as long, tag as long, wnd as long, obj as long )CGPoint              startPoint, pointCAShapeLayerRef      shapeLayerCABasicAnimationRef  animationBezierPathRef        pathCGRect               rselect (ev)case _viewMouseDownselect (tag)case _antViewshapeLayer = fn CAShapeLayerInitCALayerSetFrame( shapeLayer, fn ViewFrame(_antView) )CAShapeLayerSetStrokeColor(     shapeLayer, fn ColorBlack )CAShapeLayerSetFillColor(       shapeLayer, fn ColorClear )CAShapeLayerSetLineWidth(       shapeLayer, 1.0           )CAShapeLayerSetLineDashPattern( shapeLayer, @[@10, @5]    )ViewSetLayer( _antView, shapeLayer )// Store initial mouse down position as start pointObjectPropertySet( shapeLayer, @"startPoint", fn ValueWithPoint( fn EventLocationInView( _antView ) ) )animation = fn CABasicAnimationWithKeyPath( @"lineDashPhase" )CABasicAnimationSetFromValue( animation,  @0.0    )CABasicAnimationSetToValue(   animation, @15.0    )CAMediaTimingSetDuration(     animation,   0.75   )CAMediaTimingSetRepeatCount(  animation, INFINITY )CALayerAddAnimation( shapeLayer, animation, @"lineDashPhase" )end selectcase _viewMouseDraggedselect (tag)case _antViewshapeLayer = (CAShapeLayerRef)fn ViewLayer( _antView )startPoint = fn ValuePoint( fn ObjectProperty( shapeLayer, @"startPoint" ) )// Refresh mouse location when draggedpoint = fn EventLocationInView( _antView )path = fn BezierPathWithRect( fn CGRectMake( startPoint.x, startPoint.y, point.x - startPoint.x, point.y - startPoint.y ) )r = fn BezierPathBounds( path )CALayerSetContentsCenter( shapeLayer, r )CAShapeLayerSetPath( shapeLayer, path )end selectcase _viewMouseUpselect (tag)case _antViewshapeLayer = (CAShapeLayerRef)fn ViewLayer( _antView )r = fn CALayerContentsCenter( shapeLayer )NSLogClearNSLog( @"Marching ants rect: (%0.f, %0.f, %0.f, %0.f)", r.origin.x, r.origin.y, r.size.width, r.size.height )end selectcase _windowWillClose : endend selectend fnon dialog fn DoDialogfn BuildWindowHandleEvents