/*  Fire  From an Apple demo*/include resources "fire.png"include resources "smoke.png"_window = 1begin enum 1_view_label_sliderend enumvoid local fn SliderChangedfloat               gasCAEmitterLayerRef   fireEmitter, smokeEmitter// Query the gasSlider's valuegas = fn ControlIntValue( _slider ) / 100.0// Get fire and smoke layersfireEmitter = fn ViewProperty( _slider, @"fire" )smokeEmitter = fn ViewProperty( _slider, @"smoke" )// Update the fire propertiesObjectSetValueForKeyPath( fireEmitter, @(gas * 1000), @"emitterCells.fire.birthRate" )ObjectSetValueForKeyPath( fireEmitter, @(gas), @"emitterCells.fire.lifetime" )ObjectSetValueForKeyPath( fireEmitter, @(gas * 0.35), @"emitterCells.fire.lifetimeRange" )CAEmitterLayerSetEmitterSize( fireEmitter, fn CGSizeMake( 50 * gas, 0 ) )// Update the smoke propertiesObjectSetValueForKeyPath( smokeEmitter, @(gas * 4), @"emitterCells.smoke.lifetime" )ObjectSetValueForKeyPath( smokeEmitter, fn ColorCGColor(fn ColorWithCalibratedRGB( 1, 1, 1, gas * 0.3 )), @"emitterCells.smoke.color" )end fnvoid local fn CreateFireLayersCALayerRef          rootLayerCAEmitterLayerRef   fireEmitter, smokeEmitterCAEmitterCellRef    fire, smokeCGImageRef          fireImage, smokeImage// Get the root layerViewSetWantsLayer( _view, YES )rootLayer = fn ViewLayer( _view )// Set the root layer's background color to blackCALayerSetBackgroundColor( rootLayer, fn ColorBlack )// Create the fire emitter layerfireEmitter = fn CAEmitterLayerInitCALayerSetName( fireEmitter, @"fire" )CAEmitterLayerSetEmitterPosition( fireEmitter, fn CGPointMake(225,50) )CAEmitterLayerSetEmitterMode( fireEmitter, kCAEmitterLayerOutline )CAEmitterLayerSetEmitterShape( fireEmitter, kCAEmitterLayerLine )CAEmitterLayerSetRenderMode( fireEmitter, kCAEmitterLayerAdditive )CAEmitterLayerSetEmitterSize( fireEmitter, fn CGSizeMake(0,0) )// Create the smoke emitter layersmokeEmitter = fn CAEmitterLayerInitCALayerSetName( smokeEmitter, @"smoke" )CAEmitterLayerSetEmitterPosition( smokeEmitter, fn CGPointMake(225,50) )CAEmitterLayerSetEmitterMode( smokeEmitter, kCAEmitterLayerPoints )// Create the fire emitter cellfire = fn CAEmitterCellInitCAEmitterCellSetEmissionLongitude( fire, PI )CAEmitterCellSetBirthRate( fire, 0 )CAEmitterCellSetVelocity( fire, 80 )CAEmitterCellSetVelocityRange( fire, 30 )CAEmitterCellSetEmissionRange( fire, 1.1 )CAEmitterCellSetYAcceleration( fire, 200 )CAEmitterCellSetScaleSpeed( fire, 0.3 )CAEmitterCellSetColor( fire, fn ColorWithCalibratedRGB( 0.8, 0.4, 0.2, 0.10 ) )fireImage = fn ImageCGImageForProposedRect( fn ImageNamed(@"fire"), NULL, NULL, NULL )CAEmitterCellSetContents( fire, (ptr)fireImage )// Name the cell so that it can be animated later using keypathsCAEmitterCellSetName( fire, @"fire" )// Add the fire emitter cell to the fire emitter layerCAEmitterLayerSetEmitterCells( fireEmitter, @[fire] )// Create the smoke emitter cellsmoke = fn CAEmitterCellInitCAEmitterCellSetBirthRate( smoke, 11 )CAEmitterCellSetEmissionLongitude( smoke, PI/2 )CAEmitterCellSetLifetime( smoke, 0 )CAEmitterCellSetVelocity( smoke, 40 )CAEmitterCellSetVelocityRange( smoke, 20 )CAEmitterCellSetEmissionRange( smoke, PI/4 )CAEmitterCellSetSpin( smoke, 1 )CAEmitterCellSetSpinRange( smoke, 6 )CAEmitterCellSetYAcceleration( smoke, 160 )smokeImage = fn ImageCGImageForProposedRect( fn ImageNamed(@"smoke"), NULL, NULL, NULL )CAEmitterCellSetContents( smoke, (ptr)smokeImage )CAEmitterCellSetScale( smoke, 0.1 )CAEmitterCellSetAlphaSpeed( smoke, -0.12 )CAEmitterCellSetScaleSpeed( smoke, 0.7 )// Name the cell so that it can be animated later using keypathsCAEmitterCellSetName( smoke, @"smoke" )// Add the smoke emitter cell to the smoke emitter layerCAEmitterLayerSetEmitterCells( smokeEmitter, @[smoke] )// Add the two emitter layers to the root layerCALayerAddSublayer( rootLayer, smokeEmitter )CALayerAddSublayer( rootLayer, fireEmitter )// Store smoke and fire layers as properties of the sliderViewPropertySet( _slider, @"fire", fireEmitter )ViewPropertySet( _slider, @"smoke", smokeEmitter )// Set the fire simulation to reflect the initial slider positionfn SliderChangedend fnvoid local fn BuildWindowwindow _window, @"Fire", (0,0,538,638), NSWindowStyleMaskTitledViewSetWantsLayer( _windowContentViewTag, YES )view _view, (20,20,450,600)textlabel _label, @"Gas", (480,603,41,17)ControlSetAlignment( _label, NSTextAlignmentCenter )slider _slider,, 40, (490,17,21,580), 1, 200ControlSetContinuous( _slider, YES )fn CreateFireLayersend fnvoid local fn DoDialog( ev as long, tag as long )select ( ev )case _btnClickselect ( tag )case _slider : fn SliderChangedend selectend selectend fnfn BuildWindowon dialog fn DoDialogHandleEvents