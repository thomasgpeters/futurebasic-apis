#import "_0_TranslatedRuntime.h"
#import "FBtoC.h"
#import "General.c"
#import "Containers.c"
#import "FileHandling.c"
#import "Index.c"
#import "AppThings.c"
#import "BreakpointWindowController.m"
#import "FileHandlingUtils.m"
#import "CUI_AppDelegate.m"
#import "CocoaUI.m"
#import "CUI_AppDelegate.h"
#import "ObjCRuntime.h"
#import "CocoaUI.h"
#import "URL.m"
#import "PDFInfo.h"
#import "Invocation.h"
#import "BezierPath.m"
#import "CATransformLayer.h"
#import "Scanner.m"
#import "PathControl.h"
#import "LevelIndicator.h"
#import "Panel.m"
#import "TextCheckingResult.m"
#import "TextList.h"
#import "NumberFormatter.m"
#import "Morphology.h"
#import "PressGestureRecognizer.h"
#import "TextCheckingController.h"
#import "Progress.h"
#import "Nib.m"
#import "Measurement.m"
#import "PathComponentCell.h"
#import "AffineTransform.h"
#import "Error.h"
#import "FileManager.h"
#import "Dictionary.m"
#import "Sound.h"
#import "DockTile.m"
#import "ColorPanel.h"
#import "CAValueFunction.m"
#import "MapTable.m"
#import "JSONSerialization.h"
#import "Box.h"
#import "CompoundPredicate.h"
#import "BrowserCell.m"
#import "URLRequest.m"
#import "CAShapeLayer.m"
#import "LayoutGuide.m"
#import "Expression.m"
#import "Printer.h"
#import "Pasteboard.m"
#import "Slider.m"
#import "Thread.m"
#import "ColorList.h"
#import "DateIntervalFormatter.h"
#import "PageLayout.m"
#import "RuleEditor.h"
#import "Animation.h"
#import "KeyValueCoding.h"
#import "TokenField.h"
#import "UserDefaults.m"
#import "Enumerator.h"
#import "InflectionRule.h"
#import "GraphicsContext.h"
#import "LinguisticTagger.h"
#import "CATransform3D.m"
#import "SegmentedControl.m"
#import "AdaptiveImageGlyph.h"
#import "QLPreviewView.m"
#import "CAEmitterCell.m"
#import "Input.h"
#import "StoryboardSegue.m"
#import "ItemProvider.m"
#import "Timer.m"
#import "Task.h"
#import "OpenPanel.m"
#import "Control.h"
#import "Workspace.m"
#import "CAScrollLayer.h"
#import "SpeechSynthesizer.m"
#import "PanGestureRecognizer.h"
#import "ColorSampler.h"
#import "UserNotification.h"
#import "DraggingSession.m"
#import "Range.h"
#import "OrderedSet.h"
#import "Notification.h"
#import "Browser.m"
#import "CALayer.h"
#import "ProcessInfo.m"
#import "ISO8601DateFormatter.m"
#import "CAGradientLayer.m"
#import "SpeechRecognizer.m"
#import "Object.m"
#import "ColorSpace.m"
#import "DistributedLock.h"
#import "Port.h"
#import "TableCellView.m"
#import "WindowTabGroup.h"
#import "TrackingSeparatorToolbarItem.h"
#import "URLResponse.h"
#import "DateComponentsFormatter.h"
#import "ToolbarItem.h"
#import "ToolbarItemGroup.h"
#import "Shadow.m"
#import "VisualEffectView.h"
#import "TextFieldCell.m"
#import "AnimationContext.m"
#import "BitVector.h"
#import "RotationGestureRecognizer.m"
#import "ProgressIndicator.h"
#import "CAMediaTimingFunction.h"
#import "UndoManager.m"
#import "QLPreviewItem.m"
#import "AttributedString.m"
#import "RunningApplication.h"
#import "ExtensionRequestHandling.m"
#import "Text.h"
#import "TextInsertionIndicator.m"
#import "SecureTextField.h"
#import "RunLoop.h"
#import "PrintInfo.m"
#import "TextField.m"
#import "Stepper.m"
#import "ExtensionContext.h"
#import "Inkey.h"
#import "QLFilePreviewRequest.m"
#import "MeasurementFormatter.m"
#import "ClipView.m"
#import "PressureConfiguration.h"
#import "Storyboard.h"
#import "StackView.h"
#import "LayoutManager.m"
#import "Locale.h"
#import "MagnificationGestureRecognizer.h"
#import "SavePanel.m"
#import "DecimalNumber.m"
#import "QLPreviewPanel.h"
#import "PersonNameComponentsFormatter.m"
#import "PersonNameComponents.h"
#import "PathCell.m"
#import "FontManager.m"
#import "TimeZone.h"
#import "Button.m"
#import "QLPreviewReply.m"
#import "Menu.m"
#import "UUID.h"
#import "TextContainer.m"
#import "PointerFunctions.m"
#import "TableColumn.h"
#import "TrackingArea.h"
#import "GlyphGenerator.h"
#import "TableRowView.h"
#import "TabView.m"
#import "LayoutAnchor.h"
#import "Array.m"
#import "ParagraphStyle.m"
#import "Appearance.m"
#import "UserActivity.m"
#import "NotificationQueue.h"
#import "Event.h"
#import "CATransaction.m"
#import "TextInputClient.m"
#import "GridView.m"
#import "URLSession.m"
#import "ScrollView.h"
#import "HashTable.h"
#import "CAReplicatorLayer.h"
#import "TitlebarAccessoryViewController.h"
#import "Exception.m"
#import "CATextLayer.h"
#import "ComboBox.h"
#import "CATiledLayer.h"
#import "AppleScript.m"
#import "BitmapImageRep.m"
#import "Switch.m"
#import "TextContent.m"
#import "ComboButton.h"
#import "Data.h"
#import "StringDrawing.h"
#import "TextAttachment.h"
#import "WindowTab.m"
#import "Application.h"
#import "TextTable.h"
#import "GestureRecognizer.h"
#import "FontPanel.h"
#import "CAEmitterLayer.h"
#import "MethodSignature.h"
#import "DatePicker.m"
#import "Operation.m"
#import "SplitViewController.h"
#import "Gradient.h"
#import "PredicateEditor.m"
#import "LocalizedNumberFormatRule.h"
#import "PopUpButton.h"
#import "IndexSet.m"
#import "Bundle.h"
#import "Lock.h"
#import "KeyedArchiver.h"
#import "BackgroundActivityScheduler.m"
#import "CADisplayLink.h"
#import "Cell.h"
#import "Graphics.m"
#import "StatusBar.h"
#import "SearchToolbarItem.m"
#import "SpellChecker.h"
#import "RegularExpression.h"
#import "DateInterval.h"
#import "DraggingItem.h"
#import "TabViewItem.h"
#import "PrintPanel.h"
#import "Formatter.h"
#import "Screen.m"
#import "AppleEventDescriptor.h"
#import "SplitViewItem.h"
#import "Predicate.m"
#import "TextAlternatives.m"
#import "RelativeDateTimeFormatter.h"
#import "ScriptWhoseTests.h"
#import "Popover.m"
#import "Toolbar.m"
#import "Touch.h"
#import "FileWrapper.h"
#import "SplitView.h"
#import "RulerMarker.m"
#import "ObjCRuntime.h"
#import "TextFinder.m"
#import "LayoutConstraint.m"
#import "UserScriptTask.h"
#import "PropertyList.m"
#import "TableHeaderCell.m"
#import "PrintOperation.h"
#import "DraggingInfo.m"
#import "Font.m"
#import "CAMediaTiming.h"
#import "Date.h"
#import "ColorWell.m"
#import "Window.h"
#import "DialogEvent.m"
#import "SharingService.m"
#import "TableHeaderView.m"
#import "IndexPath.h"
#import "SharingCollaborationModeRestriction.h"
#import "Unit.h"
#import "String.m"
#import "TextView.m"
#import "Color.h"
#import "UserDefaultsController.h"
#import "SortDescriptor.h"
#import "CAAnimation.m"
#import "UserInterfaceItemIdentification.h"
#import "AppleEventManager.h"
#import "PDFPanel.m"
#import "Set.m"
#import "ImageRep.m"
#import "TermOfAddress.h"
#import "PointerArray.m"
#import "Scroller.h"
#import "Geometry.m"
#import "ViewController.m"
#import "OutlineView.m"
#import "MediaLibraryBrowserController.m"
#import "OrderedCollectionChange.m"
#import "ListFormatter.h"
#import "runtime2.h"
#import "PathControlItem.m"
#import "MenuItem.m"
#import "DateFormatter.m"
#import "OrderedCollectionDifference.m"
#import "Alert.m"
#import "TableView.h"
#import "ClickGestureRecognizer.h"
#import "Calendar.h"
#import "FileHandle.h"
#import "Stream.h"
#import "Image.m"
#import "PreviewRepresentingActivityItem.h"
#import "RulerView.m"
#import "Value.h"
#import "View.h"
#import "StatusItem.m"
#import "CharacterSet.h"
#import "UbiquitousKeyValueStore.m"
#import "MDA.h"
#import "MenuToolbarItem.m"
#import "ImageView.h"
#import "DistributedNotificationCenter.m"
#import "FontDescriptor.h"
#import "WindowController.h"
#import "Coder.m"
#import "SearchFieldCell.m"
#import "Responder.m"
#import "QLPreviewProvider.m"
#import "HelpManager.h"
#import "StatusBarButton.h"
#import "TextLabel.m"
#import "Orthography.h"
#import "MenuItemBadge.m"
#import "TintConfiguration.m"
#import "KeyValueObserving.h"
#import "ByteCountFormatter.m"
#import "URLCache.m"
#import "SearchField.m"
#import "TextStorage.h"
#import "TextCheckingClient.m"
#import "PredicateEditorRowTemplate.m"
#import "ComparisonPredicate.m"
#import "Cursor.h"
#import "QLPreviewingController.h"
#import "CALayer.m"
#import "Browser.h"
#import "ProcessInfo.h"
#import "ISO8601DateFormatter.h"
#import "Range.m"
#import "OrderedSet.m"
#import "Notification.m"
#import "Workspace.h"
#import "Control.m"
#import "CAScrollLayer.m"
#import "PanGestureRecognizer.m"
#import "SpeechSynthesizer.h"
#import "DraggingSession.h"
#import "UserNotification.m"
#import "ColorSampler.m"
#import "Timer.h"
#import "Task.m"
#import "OpenPanel.h"
#import "GraphicsContext.m"
#import "InflectionRule.m"
#import "SegmentedControl.h"
#import "AdaptiveImageGlyph.m"
#import "CATransform3D.h"
#import "LinguisticTagger.m"
#import "Input.m"
#import "CAEmitterCell.h"
#import "QLPreviewView.h"
#import "ItemProvider.h"
#import "StoryboardSegue.h"
#import "KeyValueCoding.m"
#import "UserDefaults.h"
#import "TokenField.m"
#import "Enumerator.m"
#import "PageLayout.h"
#import "RuleEditor.m"
#import "Animation.m"
#import "DateIntervalFormatter.m"
#import "Slider.h"
#import "Pasteboard.h"
#import "Thread.h"
#import "ColorList.m"
#import "BrowserCell.h"
#import "LayoutGuide.h"
#import "URLRequest.h"
#import "CAShapeLayer.h"
#import "Printer.m"
#import "Expression.h"
#import "Box.m"
#import "CompoundPredicate.m"
#import "ColorPanel.m"
#import "MapTable.h"
#import "JSONSerialization.m"
#import "CAValueFunction.h"
#import "PathComponentCell.m"
#import "AffineTransform.m"
#import "Dictionary.h"
#import "Error.m"
#import "FileManager.m"
#import "DockTile.h"
#import "Sound.m"
#import "PressGestureRecognizer.m"
#import "TextCheckingController.m"
#import "Progress.m"
#import "Measurement.h"
#import "Nib.h"
#import "TextCheckingResult.h"
#import "Panel.h"
#import "NumberFormatter.h"
#import "TextList.m"
#import "Morphology.m"
#import "URL.h"
#import "PDFInfo.m"
#import "CATransformLayer.m"
#import "Scanner.h"
#import "BezierPath.h"
#import "Invocation.m"
#import "LevelIndicator.m"
#import "PathControl.m"
#import "HashTable.m"
#import "ScrollView.m"
#import "URLSession.h"
#import "CAReplicatorLayer.m"
#import "TextInputClient.h"
#import "CATransaction.h"
#import "GridView.h"
#import "UserActivity.h"
#import "NotificationQueue.m"
#import "Event.m"
#import "Appearance.h"
#import "TableRowView.m"
#import "LayoutAnchor.m"
#import "Array.h"
#import "TabView.h"
#import "ParagraphStyle.h"
#import "QLPreviewReply.h"
#import "FontManager.h"
#import "Button.h"
#import "TimeZone.m"
#import "Menu.h"
#import "UUID.m"
#import "TableColumn.m"
#import "PointerFunctions.h"
#import "TextContainer.h"
#import "GlyphGenerator.m"
#import "TrackingArea.m"
#import "PersonNameComponentsFormatter.h"
#import "PersonNameComponents.m"
#import "PathCell.h"
#import "StackView.m"
#import "Storyboard.m"
#import "MagnificationGestureRecognizer.m"
#import "Locale.m"
#import "LayoutManager.h"
#import "QLPreviewPanel.m"
#import "SavePanel.h"
#import "DecimalNumber.h"
#import "Inkey.m"
#import "QLFilePreviewRequest.h"
#import "ExtensionContext.m"
#import "Stepper.h"
#import "TextField.h"
#import "ClipView.h"
#import "MeasurementFormatter.h"
#import "PressureConfiguration.m"
#import "TextInsertionIndicator.h"
#import "RunLoop.m"
#import "SecureTextField.m"
#import "PrintInfo.h"
#import "RunningApplication.m"
#import "ExtensionRequestHandling.h"
#import "Text.m"
#import "QLPreviewItem.h"
#import "UndoManager.h"
#import "AttributedString.h"
#import "RotationGestureRecognizer.h"
#import "BitVector.m"
#import "ProgressIndicator.m"
#import "CAMediaTimingFunction.m"
#import "AnimationContext.h"
#import "TextFieldCell.h"
#import "Shadow.h"
#import "VisualEffectView.m"
#import "WindowTabGroup.m"
#import "URLResponse.m"
#import "TrackingSeparatorToolbarItem.m"
#import "ToolbarItem.m"
#import "DateComponentsFormatter.m"
#import "ToolbarItemGroup.m"
#import "SpeechRecognizer.h"
#import "Object.h"
#import "CAGradientLayer.h"
#import "TableCellView.h"
#import "Port.m"
#import "DistributedLock.m"
#import "ColorSpace.h"
#import "Date.m"
#import "TableHeaderCell.h"
#import "PrintOperation.m"
#import "Font.h"
#import "DraggingInfo.h"
#import "CAMediaTiming.m"
#import "ObjCRuntime.m"
#import "TextFinder.h"
#import "RulerMarker.h"
#import "UserScriptTask.m"
#import "LayoutConstraint.h"
#import "PropertyList.h"
#import "SplitView.m"
#import "Popover.h"
#import "ScriptWhoseTests.m"
#import "RelativeDateTimeFormatter.m"
#import "Touch.m"
#import "Toolbar.h"
#import "FileWrapper.m"
#import "PrintPanel.m"
#import "Formatter.m"
#import "AppleEventDescriptor.m"
#import "Screen.h"
#import "Predicate.h"
#import "TextAlternatives.h"
#import "SplitViewItem.m"
#import "RegularExpression.m"
#import "DateInterval.m"
#import "DraggingItem.m"
#import "TabViewItem.m"
#import "SearchToolbarItem.h"
#import "SpellChecker.m"
#import "Cell.m"
#import "Graphics.h"
#import "StatusBar.m"
#import "BackgroundActivityScheduler.h"
#import "KeyedArchiver.m"
#import "Lock.m"
#import "CADisplayLink.m"
#import "PredicateEditor.h"
#import "LocalizedNumberFormatRule.m"
#import "IndexSet.h"
#import "PopUpButton.m"
#import "Bundle.m"
#import "Operation.h"
#import "SplitViewController.m"
#import "Gradient.m"
#import "FontPanel.m"
#import "GestureRecognizer.m"
#import "MethodSignature.m"
#import "CAEmitterLayer.m"
#import "DatePicker.h"
#import "TextAttachment.m"
#import "StringDrawing.m"
#import "TextTable.m"
#import "Application.m"
#import "WindowTab.h"
#import "ComboButton.m"
#import "TextContent.h"
#import "Switch.h"
#import "Data.m"
#import "TitlebarAccessoryViewController.m"
#import "Exception.h"
#import "ComboBox.m"
#import "CATextLayer.m"
#import "CATiledLayer.m"
#import "BitmapImageRep.h"
#import "AppleScript.h"
#import "ComparisonPredicate.h"
#import "Cursor.m"
#import "QLPreviewingController.m"
#import "SearchField.h"
#import "TextStorage.m"
#import "PredicateEditorRowTemplate.h"
#import "TextCheckingClient.h"
#import "Orthography.m"
#import "TextLabel.h"
#import "TintConfiguration.h"
#import "MenuItemBadge.h"
#import "KeyValueObserving.m"
#import "ByteCountFormatter.h"
#import "URLCache.h"
#import "SearchFieldCell.h"
#import "QLPreviewProvider.h"
#import "Responder.h"
#import "StatusBarButton.m"
#import "HelpManager.m"
#import "FontDescriptor.m"
#import "Coder.h"
#import "WindowController.m"
#import "MDA.m"
#import "UbiquitousKeyValueStore.h"
#import "CharacterSet.m"
#import "MenuToolbarItem.h"
#import "ImageView.m"
#import "DistributedNotificationCenter.h"
#import "View.m"
#import "StatusItem.h"
#import "PreviewRepresentingActivityItem.m"
#import "RulerView.h"
#import "Image.h"
#import "Value.m"
#import "Calendar.m"
#import "ClickGestureRecognizer.m"
#import "Stream.m"
#import "FileHandle.m"
#import "DateFormatter.h"
#import "MenuItem.h"
#import "OrderedCollectionDifference.h"
#import "TableView.m"
#import "Alert.h"
#import "OrderedCollectionChange.h"
#import "MediaLibraryBrowserController.h"
#import "PathControlItem.h"
#import "runtime2.m"
#import "ListFormatter.m"
#import "Geometry.h"
#import "Scroller.m"
#import "PointerArray.h"
#import "OutlineView.h"
#import "ViewController.h"
#import "CAAnimation.h"
#import "SortDescriptor.m"
#import "PDFPanel.h"
#import "AppleEventManager.m"
#import "UserInterfaceItemIdentification.m"
#import "ImageRep.h"
#import "Set.h"
#import "TermOfAddress.m"
#import "UserDefaultsController.m"
#import "SharingCollaborationModeRestriction.m"
#import "String.h"
#import "Unit.m"
#import "Color.m"
#import "TextView.h"
#import "Window.m"
#import "DialogEvent.h"
#import "ColorWell.h"
#import "IndexPath.m"
#import "TableHeaderView.h"
#import "SharingService.h"
#import "ArrayIndices.h"

///////////////////////////////////////////////////
//       translated globals and fns              //
///////////////////////////////////////////////////
 

//////////////////// Leave in AE. See AE comment in Tblx Standard.incl too. // Brian 20190804

//////////////////// Leave in some structures still used.  Brian 20190804

////////////// Apple Events are possible in 32 and 64-bit builds, so not conditionally (#if) removed. // Brian 20190804

 
long  FBInstallAEHandler( AEEventClass aeClass, AEEventID aeType, void* aeProc, SRefCon x, Boolean y ) 
{
  OSErr             err; 
  err = AEInstallEventHandler( aeClass, aeType, aeProc, x, y ); 
  return err; 
}  
  
 
#import <malloc/malloc.h>
#import <string.h>
 
 
long  FBPStr2CStr( void* strPtr ) 
{
  long              strlength; 
  strlength = *(unsigned char*)(strPtr); 
  memmove( strPtr, strPtr + 1, strlength ); 
  *(char*)( strPtr + strlength ) = 0; 
  return 0; 
}  
  
 
long  FBCStr2PStr( void* strPtr ) 
{
  void*             p; 
  long              strlength; 
  strlength = 0; 
  p = strPtr; 
 
  while ( *(unsigned char*)p ) 
  { 
  p++; 
  strlength++; 
  } 
  if ( strlength > 255 ) { 
  strlength = 255; 
  } 
  memmove( strPtr + 1, strPtr, strlength ); 
///BlockMoveData( strPtr, strPtr+1, strlen )Â 

  *(unsigned char*)strPtr = strlength; 
  return 0; 
}  
  
SInt8             gFBUpperChar[256]; 
SInt8             gFBLowerChar[256]; 
 
long  InitFBGlobals( void ) 
{
  SInt32            j; 
for( j = 0; j < 256; j++ ) {
gFBUpperChar[j] = toupper( j );
gFBLowerChar[j] = tolower( j );
}
#ifndef DECARBONATE
sranddev(); // randomize at startup
#endif
  return 0; 
}  
  
CFBundleRef       gSysBundle; 
 
CFBundleRef  CreateBundleForFramework( Str255 framework_p ) 
{
  Str255 framework;  PSstrcpy( framework, framework_p ); 
  gFBStk -= 1; 
  CFBundleRef       bundle; 
  bundle = (void*)0; 
  CFURLRef          theBundleURL; 
  CFURLRef          baseURL; 
  baseURL = (void*)0; 
  CFStringRef       frameworkCFStr; 
  CFStringRef       msg; 
  frameworkCFStr = CFStringCreateWithPascalString( NULL, (void*)&framework, kCFStringEncodingASCII ); 
NSFileManager *fm = [NSFileManager defaultManager];
baseURL =(__bridge CFURLRef)[fm URLForDirectory:NSLibraryDirectory
inDomain:NSSystemDomainMask
appropriateForURL:NULL
create:NO
error:NULL];
  if ( baseURL ) { 
  theBundleURL = CFURLCreateCopyAppendingPathComponent( NULL, baseURL, (CFStringRef)frameworkCFStr, false ); 
  bundle = CFBundleCreate( NULL, theBundleURL ); 
  if ( theBundleURL ) { 
  CFRelease( theBundleURL ); 
  } 
  } 
  if ( bundle == 0 ) { 
  msg = CFStringCreateWithFormat( kCFAllocatorDefault, NULL, CFSTR( "Framework bundle \"%@\" not found" ), frameworkCFStr ); 
 FBShutdown((void *)msg, true ); 
  CFRelease( msg ); 
  } 
  CFRelease( frameworkCFStr ); 
  return bundle; 
}  
  
 
void*  GetMachFunctionFromBundle( void* bndl, Str255 name_p ) 
{
  Str255 name;  PSstrcpy( name, name_p ); 
  gFBStk -= 1; 
  CFStringRef       stringRef; 
  CFStringRef       msg; 
  void*             fptr; 
  fptr = (void*)0; 
  stringRef = CFStringCreateWithPascalString( NULL, (void*)&name, kCFStringEncodingASCII ); 
  if ( stringRef ) { 
  fptr = CFBundleGetFunctionPointerForName( bndl, (CFStringRef)stringRef ); 
  } 
  if ( fptr ) { 
  fptr = (void*)*(long*)(fptr); 
  } else { 
  msg = CFStringCreateWithFormat( kCFAllocatorDefault, NULL, CFSTR( "BSD function \"%@\" not found" ), stringRef ); 
 FBShutdown((void *)msg, true ); 
  CFRelease( msg ); 
  } 
  CFRelease( stringRef ); 
  return fptr; 
}  
  
 
void  DynamicClear( UInt8 dynArrayNum ) 
{
long elemSize = gFBDynArrayInfo[dynArrayNum].elemSize; // save elemSize
bzero( gFBDynArrayInfo[dynArrayNum].base,( gFBDynArrayInfo[dynArrayNum].lastElem + 1 ) * elemSize );
gFBDynArrayInfo[dynArrayNum].lastElem = -1;
gFBDynArrayInfo[dynArrayNum].elemSize = elemSize; // restore - //2024-Jan-30 Brian
}  
  
 
long  DynamicNextElement( UInt8 array ) 
{
  long              nextElement; 
nextElement = gFBDynArrayInfo[array].lastElem + 1;
(void)FBDynamicArray( array, nextElement ); // ensure next element is allocated ; #641 was FBGrowDynamicArray
gFBDynArrayInfo[array].lastElem = nextElement - 1; // restore
  return nextElement; 
}  
  
 
long  DynamicRemoveItems( SInt32 dynArrayNum, long first, long howMany, void* savePtr ) 
{
  long              itemSize; 
  long              itemCount; 
  long              lastElem; 
  void*             base; 
// info from *.c runtime globals
itemSize = gFBDynArrayInfo[dynArrayNum].elemSize;
base = gFBDynArrayInfo[dynArrayNum].base;
itemCount = gFBDynArrayInfo[dynArrayNum].maxIndex;
lastElem = gFBDynArrayInfo[dynArrayNum].lastElem; // #642
  if ( (first < 0) | (first > lastElem) ) { 
  goto LL0; 
  } 
  if ( first + howMany - 1 > lastElem ) { 
  howMany = lastElem - first + 1; 
  } 
  if ( howMany > 0 ) { 
gFBDynArrayInfo[dynArrayNum].lastElem -= howMany;
  if ( savePtr ) { 
  memmove( savePtr, base + first * itemSize, howMany * itemSize ); 
  } 
  memmove( base + first * itemSize, base + (first + howMany) * itemSize, (itemCount - first - howMany) * itemSize ); 
  memset( base + (itemCount - howMany) * itemSize, 0, howMany * itemSize ); 
  } 
LL0:; 
  return 0; 
}  
  
 
long  DynamicInsertItems( SInt32 dynArrayNum, long where, long howMany, void* fillPtr ) 
{
  long              itemSize; 
  long              itemCount; 
  void*             base; 
  if ( (where < 0) | (howMany < 0) ) { 
  goto LL1; 
  } 
// info from *.c runtime globals
itemSize = gFBDynArrayInfo[dynArrayNum].elemSize;
itemCount = gFBDynArrayInfo[dynArrayNum].maxIndex;
  if ( itemCount < where ) { 
  itemCount = where; 
  } 
FBGrowDynamicArray( dynArrayNum, itemCount + howMany ); // make room
gFBDynArrayInfo[dynArrayNum].lastElem += howMany; // bump the last elem a/c to num inserted
base = gFBDynArrayInfo[dynArrayNum].base;
  memmove( base + (where + howMany) * itemSize, base + where * itemSize, (itemCount - where) * itemSize ); 
  if ( fillPtr == 0 ) { 
  memset( base + where * itemSize, 0, howMany * itemSize ); 
  } else { 
  memmove( base + where * itemSize, fillPtr, howMany * itemSize ); 
  } 
LL1:; 
  return 0; 
}  
  
 











//////////////////////////////////////////////////////

//////////////////////////////////////////////////////

void  BlockFill( void* address, unsigned long bytes, long byteVal ) 
{
  memset( address, byteVal, bytes ); 
}  
  
 
void  LongBlockFill( void* address, unsigned long bytes, long byteVal ) 
{
  memset( address, byteVal, bytes ); 
}  
  
 
void  TRUNCATE( void* StrPtr ) 
{
  UInt8             strLength = *(unsigned char*)(StrPtr); 
 
  while ( (strLength > 0) & (*(unsigned char*)(StrPtr + strLength) == (unsigned char)' ') ) 
  { 
  strLength--; 
  } 
  *(char*)( StrPtr ) = strLength; 
}  
  
 
long  roundUp( double f ) 
{
  double            ff; 
  ff = frac( f ); 
  if ( (ff < 0.0) | (ff > 0.0) ) { 
  f += sgn( f ); 
  } 
  return trunc( f ); 
}  
  
 
long  roundDown( double f ) 
{
  return trunc( f ); 
}  
  
 
void  LCASE( void* sPtr ) 
{
  void*             endAddr; 
  void*             addr; 
  addr = sPtr; 
  endAddr = *(unsigned char*)addr + addr; 
 
  while ( addr < endAddr ) 
  { 
  addr = (void*)addr + 1; 
  *(unsigned char*)addr = gFBLowerChar[ChkBounds( *(unsigned char*)addr, 255, 69, CFSTR("Subs DefUsr.incl") )]; 
  } 
}  
  
 
NSDecimal NSDecimalWithString( CFStringRef string )
{
NSDecimal dcm;
NSScanner *scanner = [NSScanner scannerWithString:(__bridge NSString *)string];
[scanner scanDecimal:&dcm];
return dcm;
}
 

CFCharacterSetRef  CharacterSetPuntuationSet( void ) 
{
  return CharacterSetPunctuationSet(); 
}  
  
 
CFMutableCharacterSetRef  MutableCharacterSetPuntuationSet( void ) 
{
  return MutableCharacterSetPunctuationSet(); 
}  
  
 
CFStringRef nsHFSTypeOfFileAtURL( CFURLRef url )
{ return(__bridge CFStringRef)NSHFSTypeOfFile( [(__bridge NSURL *)url path] ); }
 
CFStringRef  StringWithPascalString( Str255 s_p ) 
{
  Str255 s;  PSstrcpy( s, s_p ); 
  gFBStk -= 1; 
  return StringWithFormat( CFSTR( "%.*s" ), s[0], (void*)&s[1] ); 
}  
  
 
StringPtr StringPascalString( CFStringRef string ) 
{
  gFBStk++; 
  Str255            s; 
  s[0] = 0; 
  CFStringGetPascalString( (CFStringRef)string, (void*)&s, 256, kCFStringEncodingMacRoman ); 
  gFBStk--; 
  return PSstrcpy( gReturnedString, s ); 
}  
  
 
CFMutableDictionaryRef ioServiceMatching( CFStringRef name )
{ return IOServiceMatching( [(__bridge NSString *)name cStringUsingEncoding:NSUTF8StringEncoding] ); }
 

long  FBXInitBSDSystemFramework( void ) 
{
  if ( gSysBundle == 0 ) { 
  gSysBundle = CreateBundleForFramework( PSstrcpy( STACK_PUSH(), "\pFrameworks/System.framework" ) ); 
  } 
  return 0; 
}  
  
 
long  e_xit( SInt32 status ) 
{
_exit((int)status );
  return 0; 
}  
  
UInt16            gFBSerialPortCount = 0; 
CFMutableArrayRef gFBSerialName = 0; 
CFMutableArrayRef gFBSerialInName = 0; 
CFMutableArrayRef gFBSerialOutName = 0; 
Boolean           gOSXSerialInited; 
 
long  FBXSerialGetSerialIterator( io_iterator_t * matchingServices ) 
{
  mach_port_t       masterPort = 0; 
  CFMutableDictionaryRef classesToMatch = 0; 
  kern_return_t     kernResult = IOMasterPort( MACHPORTNULL, (void*)&masterPort ); 
  if ( KERNSUCCESS == kernResult ) { 
  classesToMatch = ioServiceMatching( (CFStringRef)kIOSerialBSDServiceValue ); 
  if ( classesToMatch ) { 
  CFDictionarySetValue( classesToMatch, kIOSerialBSDTypeKey, kIOSerialBSDAllTypes ); 
  } 
  } 
  return IOServiceGetMatchingServices( masterPort, classesToMatch, matchingServices ); 
}  
  
 
long  FBXSerialGetCountAndNames( io_iterator_t serialPortIterator ) 
{
  io_object_t       serialService = IOIteratorNext( serialPortIterator ); 
 
  while ( serialService != 0 ) 
  { 
  CFTypeRef         serialNameCFStr = IORegistryEntryCreateCFProperty( serialService, (CFStringRef)kIOTTYDeviceKey, NULL, 0 ); 
  if ( serialNameCFStr ) { 
  if ( gFBSerialPortCount < 12 ) { 
  gFBSerialPortCount++; 
  MutableArrayInsertObjectAtIndex( gFBSerialName, serialNameCFStr, gFBSerialPortCount ); 
  } 
  CFTypeRef         bsdPathCFStr = IORegistryEntryCreateCFProperty( serialService, (CFStringRef)kIOCalloutDeviceKey, NULL, 0 ); 
  if ( gFBSerialPortCount < 12 ) { 
  if ( bsdPathCFStr ) { 
  MutableArrayInsertObjectAtIndex( gFBSerialOutName, bsdPathCFStr, gFBSerialPortCount ); 
  MutableArrayInsertObjectAtIndex( gFBSerialInName, bsdPathCFStr, gFBSerialPortCount ); 
  } 
  } 
  if ( bsdPathCFStr ) { 
  CFRelease( bsdPathCFStr ); 
  } 
  } 
  if ( serialNameCFStr ) { 
  CFRelease( serialNameCFStr ); 
  } 
  IOObjectRelease( serialService ); 
  serialService = IOIteratorNext( serialPortIterator ); 
  } 
  return 0; 
}  
  
 
long  FBXSerialSetBaud( termios * options, long speed ) 
{
 
  gSelectL[1] = (speed); 
  if ( gSelectL[1] >= 230400 ) 
  { 
  speed = 230400; 
  } 
  else  if ( gSelectL[1] >= 115200 ) 
  { 
  speed = 115200; 
  } 
  else  if ( gSelectL[1] >= 76800 ) 
  { 
  speed = 76800; 
  } 
  else  if ( gSelectL[1] >= 57600 ) 
  { 
  speed = 57600; 
  } 
  else  if ( gSelectL[1] >= 38400 ) 
  { 
  speed = 38400; 
  } 
  else  if ( gSelectL[1] >= 28800 ) 
  { 
  speed = 28800; 
  } 
  else  if ( gSelectL[1] >= 19200 ) 
  { 
  speed = 19200; 
  } 
  else  if ( gSelectL[1] >= 14400 ) 
  { 
  speed = 14400; 
  } 
  else  if ( gSelectL[1] >= 9600 ) 
  { 
  speed = 9600; 
  } 
  else  if ( gSelectL[1] >= 7200 ) 
  { 
  speed = 7200; 
  } 
  else  if ( gSelectL[1] >= 4800 ) 
  { 
  speed = 4800; 
  } 
  else  if ( gSelectL[1] >= 2400 ) 
  { 
  speed = 2400; 
  } 
  else  if ( gSelectL[1] >= 1800 ) 
  { 
  speed = 1800; 
  } 
  else  if ( gSelectL[1] >= 1200 ) 
  { 
  speed = 1200; 
  } 
  else  if ( gSelectL[1] >= 600 ) 
  { 
  speed = 600; 
  } 
  else  if ( gSelectL[1] >= 300 ) 
  { 
  speed = 300; 
  } 
  else  if ( gSelectL[1] >= 200 ) 
  { 
  speed = 200; 
  } 
  else  if ( gSelectL[1] >= 150 ) 
  { 
  speed = 150; 
  } 
  else  if ( gSelectL[1] >= 134 ) 
  { 
  speed = 134; 
  } 
  else  { 
  speed = 110; 
  } 
 
  return cfsetspeed( options, speed ); 
}  
  
 
long  FBXOpenSerialPort( CFStringRef path, long speed, long parity, long stopBits, long charSize, termios * origOptions ) 
{
  termios           options; 
  void*             p = StringUTF8String( (CFStringRef)path ); 
  SInt16            fileDescriptor = open( p, (2) | ((0) | (4)) ); 
  if ( fileDescriptor != - 1 ) { 
  if ( fcntl( fileDescriptor, 4, 0 ) != - 1 ) { 
  if ( tcgetattr( fileDescriptor, origOptions ) != - 1 ) { 
  options = *origOptions; 
  cfmakeraw( (void*)&options ); 
  options.c_cflag = (options.c_cflag) | ((32768) | (2048)); 
  options.c_lflag = (options.c_lflag) & (~(2)); 
  options.c_cc[ChkBounds( 16, 19, 192, CFSTR("OSX SerialIO.incl") )] = 0; 
  options.c_cc[ChkBounds( 17, 19, 193, CFSTR("OSX SerialIO.incl") )] = 0; 
  FBXSerialSetBaud( (void*)&options, speed ); 
 
  gSelectL[1] = parity; 
  if ( gSelectL[1] == 1 ) 
  { 
  options.c_cflag = (options.c_cflag) | ((4096) | (8192)); 
  } 
  else  if ( gSelectL[1] == 2 ) 
  { 
  options.c_cflag = ((options.c_cflag) | (4096)) & (~(8192)); 
  } 
  else  { 
  options.c_cflag = (options.c_cflag) & (~(4096)); 
  } 
 
  if ( stopBits == 1 ) { 
  options.c_cflag = (options.c_cflag) | (1024); 
  } else { 
  options.c_cflag = (options.c_cflag) & (~(1024)); 
  } 
  long              setCharSize; 
 
  gSelectL[1] = charSize; 
  if ( gSelectL[1] == 2 ) 
  { 
  setCharSize = 0; 
  } 
  else  if ( gSelectL[1] == 3 ) 
  { 
  setCharSize = 256; 
  } 
  else  if ( gSelectL[1] == 0 ) 
  { 
  setCharSize = 512; 
  } 
  else  { 
  setCharSize = 768; 
  } 
 
  options.c_cflag = ((options.c_cflag) & (~(768))) | ((setCharSize) & (768)); 
  if ( tcsetattr( fileDescriptor, 0, (void*)&options ) == - 1 ) { 
  fileDescriptor = - 1; 
  } 
  } else { 
  fileDescriptor = - 1; 
  } 
  } else { 
  fileDescriptor = - 1; 
  } 
  } else { 
  } 
  if ( fileDescriptor != - 1 ) { 
  close( fileDescriptor ); 
  } 
  return fileDescriptor; 
}  
  
 
long  FBXHandShake( SInt16 fileDescriptor, long controlMode ) 
{
  termios           options; 
  long              flags; 
  if ( fileDescriptor > 0 ) { 
  if ( tcgetattr( fileDescriptor, (void*)&options ) != - 1 ) { 
 
  gSelectL[1] = controlMode; 
  if ( gSelectL[1] == 0 ) 
  { 
  options.c_cflag = (options.c_cflag) & (~(196608)); 
  options.c_iflag = (options.c_iflag) & (~((512) | ((1024) | (2048)))); 
  } 
  else  if ( gSelectL[1] == 1 ) 
  { 
  options.c_cflag = (options.c_cflag) | (196608); 
  options.c_iflag = (options.c_iflag) & (~((512) | ((1024) | (2048)))); 
  } 
  else  if ( gSelectL[1] == -1 ) 
  { 
  options.c_cflag = (options.c_cflag) & (~(196608)); 
  options.c_iflag = (options.c_iflag) | ((512) | ((1024) | (2048))); 
  } 
  else  if ( gSelectL[1] == 2 ) 
  { 
  if ( ioctl( fileDescriptor, 1074033770, (void*)&flags ) != - 1 ) { 
  flags = (flags) | (2); 
  ioctl( fileDescriptor, -2147191699, (void*)&flags ); 
  } 
  } 
  else  if ( gSelectL[1] == -2 ) 
  { 
  if ( ioctl( fileDescriptor, 1074033770, (void*)&flags ) != - 1 ) { 
  flags = (flags) & (~(2)); 
  ioctl( fileDescriptor, -2147191699, (void*)&flags ); 
  } 
  } 
 
  tcsetattr( fileDescriptor, 0, (void*)&options ); 
  } 
  } 
  return 0; 
}  
  
 
long  FBInitSerialPorts( void ) 
{
  io_iterator_t     serialPortIterator; 
  if ( (gOSXSerialInited == false) || (gFBSerialPortCount == 0) ) { 
  gOSXSerialInited = true; 
  if ( (gFBSerialName != 0) && ((gFBSerialInName != 0) && (gFBSerialOutName != 0)) ) { 
  } else { 
  gFBSerialName = CFArrayCreateMutable( kCFAllocatorDefault, 12, (void*)&kCFTypeArrayCallBacks ); 
  gFBSerialInName = CFArrayCreateMutable( kCFAllocatorDefault, 12, (void*)&kCFTypeArrayCallBacks ); 
  gFBSerialOutName = CFArrayCreateMutable( kCFAllocatorDefault, 12, (void*)&kCFTypeArrayCallBacks ); 
  MutableArrayAddObject( gFBSerialName, CFSTR( "filler" ) ); 
  MutableArrayAddObject( gFBSerialInName, CFSTR( "filler" ) ); 
  MutableArrayAddObject( gFBSerialOutName, CFSTR( "filler" ) ); 
  } 
  if ( FBXSerialGetSerialIterator( (void*)&serialPortIterator ) == noErr ) { 
  FBXSerialGetCountAndNames( serialPortIterator ); 
  } 
  } 
  return 0; 
}  
  
 
long  FBSerialOpen( long fileRef, long baudRate, long parity, long stopBits, long charSize, long buffSize ) 
{
  int               portNum; 
  int               i; 
  CFStringRef       path; 
  void*             buff; 
  long              fd; 
  termios           origOptions; 
  portNum = (int)-fileRef;//2023-Jul-20 Brian 
  if ( (portNum <= 0) || (portNum > gFBSerialPortCount) ) { 
  FBCheckFileError( fileRef, -37 ); 
  goto LL2; 
  } 
  i = portNum + 256; 
  if ( gFBOpenFiles[ChkBounds( i, 267, 340, CFSTR("OSX SerialIO.incl") )].fileDescriptor ) { 
  FBCheckFileError( fileRef, -47 ); 
  goto LL2; 
  } 
  FBInitSerialPorts(); 
  path = FBShortcutArrayGetter( gFBSerialOutName, portNum ); 
  if ( buffSize < 4096 ) { 
  buffSize = 4096; 
  } 
  if ( buffSize > 32768 ) { 
  buffSize = 32768; 
  } 
  buff = malloc( buffSize ); 
  fd = FBXOpenSerialPort( (CFStringRef)path, baudRate, parity, stopBits, charSize, (void*)&origOptions ); 
  if ( fd < 0 ) { 
  free( buff ); 
  FBCheckFileError( fileRef, -36 ); 
  goto LL2; 
  } 
  gFBOpenFiles[ChkBounds( i, 267, 360, CFSTR("OSX SerialIO.incl") )].isOpen = true; 
  gFBOpenFiles[ChkBounds( i, 267, 362, CFSTR("OSX SerialIO.incl") )].buff = buff; 
  gFBOpenFiles[ChkBounds( i, 267, 363, CFSTR("OSX SerialIO.incl") )].buffSize = buffSize; 
  gFBOpenFiles[ChkBounds( i, 267, 364, CFSTR("OSX SerialIO.incl") )].fileDescriptor = fd; 
LL2:; 
  return 0; 
}  
  
 
long  FBHandShake( long fileRef, long flags ) 
{
  int               portNum; 
  SInt16            fd; 
  portNum = (int)-fileRef; //2023-Jul-20 Brian 
  if ( (portNum > 0) && (portNum <= gFBSerialPortCount) ) { 
  fd = gFBOpenFiles[ChkBounds( portNum + 256, 267, 375, CFSTR("OSX SerialIO.incl") )].fileDescriptor; 
  if ( fd ) { 
  FBXHandShake( fd, flags ); 
  } 
  } 
  return 0; 
}  
  
 
long  TermGetStatus( long fileRef ) 
{
  int               portNum; 
  int               portStatus; 
  SInt16            fd; 
  FBInitSerialPorts(); 
  portNum = (int)-fileRef; //2023-Jul-20 Brian 
  if ( (portNum <= 0) || (portNum > gFBSerialPortCount) ) { 
  portStatus = 3; 
  goto LL3; 
  } 
  if ( gFBOpenFiles[ChkBounds( portNum + 256, 267, 393, CFSTR("OSX SerialIO.incl") )].fileDescriptor ) { 
  portStatus = 2; 
  goto LL3; 
  } 
  void*             p = StringUTF8String( (CFStringRef)ArrayObjectAtIndex( gFBSerialOutName, portNum ) ); 
  fd = open( p, (2) | ((0) | (4)) ); 
  portStatus = 0; 
  if ( fd == - 1 ) { 
  portStatus = 2; 
  } 
  close( fd ); 
LL3:; 
  return portStatus; 
}  
  

